<div class="table-wrapper card">
  <h2>Inscrições</h2>
  @if (registrations$ | async; as registrations;) {
  <div class="table-header">
    <div class="payment-toggle-group">
      <button
        nbButton
        size="small"
        [status]="paymentFilter === 'all' ? 'primary' : 'basic'"
        (click)="setPaymentFilter('all')"
      >
        Todos
      </button>
      <button
        nbButton
        size="small"
        [status]="paymentFilter === 'true' ? 'success' : 'basic'"
        (click)="setPaymentFilter('true')"
      >
        Pagos
      </button>
      <button
        nbButton
        size="small"
        [status]="paymentFilter === 'false' ? 'danger' : 'basic'"
        (click)="setPaymentFilter('false')"
      >
        Pendentes
      </button>
    </div>
    <ng-container>
      <button
        nbButton
        status="success"
        size="small"
        (click)="openExportDialog(exportDialog)"
      >
        Exportar CSV
      </button>
    </ng-container>
  </div>
  <p-table
    #table
    dataKey="id"
    sortField="name"
    class="table"
    [value]="filteredRegistrations"
    [sortOrder]="1"
  >
    <ng-template #header>
      <tr>
        <th style="width: 3rem">#</th>
        <th
          pSortableColumn="name"
          style="width: 20%"
        >
          <p-sortIcon field="name" />
          Nome
        </th>
        <th>Idade</th>
        <th>Igreja</th>
        <th class="gender-column">
          <ng-container>
            Gênero
          </ng-container>
          <ng-container>
            <p-columnFilter
              field="gender"
              display="menu"
              matchMode="equals"
              [showOperator]="false"
              [showMatchModes]="false"
              [showAddButton]="false"
              [showApplyButton]="false"
            >
              <ng-template #filter let-value let-filter="filterCallback">
                <p-select
                  [ngModel]="value"
                  [options]="genders"
                  (onChange)="filter($event.value)"
                  placeholder="Selecionar gênero"
                  [showClear]="false"
                >
                  <ng-template #item let-option>
                    <span>{{ option.label }}</span>
                  </ng-template>
                </p-select>
              </ng-template>
            </p-columnFilter>
          </ng-container>
        </th>
        <th>Nome do responsável</th>
        <th>Telefone</th>
        <th>Pagamento confirmado</th>
        <th>Criado em</th>
        <th style="width: 6rem"></th>
      </tr>
    </ng-template>
    <ng-template #body let-reg let-rowIndex="rowIndex">
      <tr [ngClass]="{ 'unpaid-row': !reg.paymentConfirmed }">
        <td>{{ rowIndex + 1 }}</td>
        <td>{{ reg.name }}</td>
        <td>{{ reg.age }}</td>
        <td>{{ reg.churchName }}</td>
        <td>{{ reg.gender }}</td>
        <td>{{ reg.responsibleName }}</td>
        <td>{{ reg.responsiblePhone | phoneFormat }}</td>
        <td>{{ reg.paymentConfirmed ? 'Sim' : 'Não' }}</td>
        <td>{{ reg.createdAt | date : 'short' }}</td>
        <td class="refresh-btn">
          <p-toast />
          <p-button
            icon="pi pi-refresh"
            (click)="updatePaymentStatus(reg)"
            severity="secondary"
            rounded
          />
        </td>
      </tr>
    </ng-template>
  </p-table>
  } @else {
  <div class="loading-container">
    <ng-container *ngTemplateOutlet="loading"></ng-container>
  </div>
  }
</div>

<ng-template #loading>
  <mat-spinner size="50"></mat-spinner>
</ng-template>

<ng-template #exportDialog let-ref="dialogRef">
  <nb-card class="export-dialog">
    <nb-card-header>
      <nb-icon icon="download-outline"></nb-icon>
      <span> Exportar CSV </span>
    </nb-card-header>
    <nb-card-body>
      <div class="mt-2">
        Deseja exportar as inscrições atuais como CSV?
      </div>
    </nb-card-body>
    <nb-card-footer class="export-actions">
      @if (isExporting()) {
        <div class="export-progress">
          <span>Gerando...</span>
        </div>
      } @else {
        <div class="footer-container">
          <div class="export-filter">
            <p-select
              [ngModel]="exportPaymentFilter"
              (ngModelChange)="exportPaymentFilter = $event"
              [options]="exportPaymentOptions"
              placeholder="Filtrar por pagamento"
              [showClear]="false"
              [disabled]="isExporting()"
            >
              <ng-template #item let-option>
                <span>{{ option.label }}</span>
              </ng-template>
            </p-select>
          </div>
          <div class="export-actions">
            <button
              nbButton
              size="small"
              status="basic"
              (click)="ref.close()"
              [disabled]="isExporting()"
            >
              Cancelar
            </button>
            <button
              nbButton
              size="small"
              status="success"
              (click)="confirmExport()"
              [disabled]="isExporting()"
            >
              Exportar
            </button>
          </div>
        </div>
      }
    </nb-card-footer>
  </nb-card>
</ng-template>